sudo: required

language: elixir
elixir: '1.6'
otp_release: '20.0'
services:
- docker
env:
  global:
  - IMAGE_NAME=firestarter/example-phoenix-app
  - REGISTRY_USER=firestarter
  # REGISTRY_PASS=...
  - secure: teccPk538YYCxh4XyQFc7txDwWtIsYcOkSlOFCmjcbYauqxW6YrpZbwwPOhIhFXvXjD5odJGS8/3pCMPhAPes+Z2LsS6g1F+SCiG/EJWzJHYjos79EW7i1Sxzw86SdGb4sJRbzyyIWQBmLEH+HSqti4KVbbcWuQSNefmZ8W9MgNmt4obP/BwBhLvXrtu+IaQ4245KWIGJt+BvvB9GV/X/Q6cNv2LouxUtNhv7+Hr18JrACDaGfZzwqyPU5eiVb0uC4w7I86SwpQZcmKudk1bZlgs41xWhHQJzLpw9u/0XLt4bgIQdyOvXCruNAP/+D+B7I1KRaYXjZw9mwUxnsfhwwpm5NUVBwct+gfq1eQSefzbrY2pLCESv65Qf6M/HzkzOt9WqXrXyBMEWZc8KJLrQ0i6ek8nvGsfj7wljNaBe6amL96YulDt/y4te58lUN5NflILXBLhKineqYnxzm/8lscDXHH8Ce5k/7gY4jErFwT0WU1DPyC8QBk67NjyXDVT0OBl7dQapMe3h8xlpxBUD3s1ipn3gcTmJSAXO5MtZzOqJkZI5a3mAum/+7g17YFo0w4nILoN/Kv838yNZeSmzo0OIjeV/+LnPBJkF9EHijvUA6EuQjKVZ52XUbzN7YPmE83fm7++2tPZfwJ+5KJndIKz4J0Y+Sj3RVLJmZht64o=

install: "./install-dependencies.sh"
before_script:
- docker pull "$IMAGE_NAME" || true
- secure: w22Gr0h+WC7OUaKbLQAznlX1Y8+4tAOCIV2kMf5rxSFdnFlley2gXIe0mklxOolOcKMAUe7IJzwllMA2BJVo7tt4hzELqbogSocJiPWgzvcmFUGmlgUPfzHzj8mVSl4fSUr4+MCyUaH7Th86DnZPJnV7BPlPWEk2LlCrxSj2HehcB8nsmJpPxuqe5BJTzlPfXWEFOs1LEk5ubdHJ8GBbL0utPeQq2mFt2SSX7u/WlL0eKfmBgSy/M9k0/sG/TGU/E/8EmDAFCjezvEXQWqgzeks6EUAHOfAyPID2aWONke6eO5m6R/jFNiSGjf8rD+Hd0tdqZqWV49TUQiWrIWAFr21Y3kaBepmNIWuCkZouujopMMUwnx/sEQ54Y/mbZM5XYWogPfNoQm9YQzqlcu/JVXFi3ILi4jRN2/erNiOSljll91f1aYTs9NVeDqhVv+EbCAWzqdsPyNxUlZsxDU8g3utymojzeanLd0RXm14kAGgMPm+i8a8orUCaHosoLOJj2jJcAvVW/BTksPwohzbCpymWWYKWAjkgbSD2cb5xkWWzC1Cg4Bnx29WX62UfeIk+jlxX+RWA0M7GSz3LbZ6Iz5feR0pRS4VmXde1nyzQgCoW9xabU+lOUpMhd5Ne0ASxI7m2WFxTzz6NtC7My1WPYvR3USIk9qb1OBi+wGSN4YU=

script:
- "./build-script.sh"
- docker build --pull --cache-from "$IMAGE_NAME" --tag "$IMAGE_NAME" .
after_script:
- docker images
before_deploy:
- docker login -u "$REGISTRY_USER" -p "$REGISTRY_PASS"
- docker tag "$IMAGE_NAME" "${IMAGE_NAME}:latest"
#- docker tag "$IMAGE_NAME" "${IMAGE_NAME}:${version}"
deploy:
  provider: script
  script: docker push "${IMAGE_NAME}:latest" #&& docker push "${IMAGE_NAME}:${version}"
  on: 
    branch: master
